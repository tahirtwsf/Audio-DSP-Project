/*
These functions allow you to perform DSP on a per-frame or per-sample basis.
When processing on a per-sample basis, there are separate functions for left and right channels.
When processing on a per-frame basis, the left and right channels are interleaved.
The sample rate and frame size can be modified in lab.h.
You can also configure which of the four functions are active in lab.h

		Developed by Dan Jacobellis, University of Texas at Austin
		Modified by Richard Dansereau, Carleton University, 2022-23
		Modified by Tahir Towsif, Carleton Universtiy, 2022-2023
*/

#include <malloc.h>
#include "main.h"
#include "lab.h"

// These functions allow estimation of the number of elapsed clock cycles
extern void tic(void);
extern uint32_t toc(void);

extern uint8_t spectrum_input_or_output;   // Compute spectrum for either input (0) or output (1)

#ifdef ENABLE_VISUALIZATION
	// Variables used for the spectrum visualization
	extern arm_rfft_fast_instance_f32 fft_inst;
	extern float32_t fft_in[CHANNEL_SIZE];
	extern float32_t fft_out[CHANNEL_SIZE];
	extern float32_t fft_mag[CHANNEL_SIZE/2];  // Only need positive half of FFT magnitude
	extern void calculate_spectrum(int16_t* buffer);
#endif /* ENABLE_VISUALIZATION */

// Declare variables local to this file
uint32_t elapsed_cycles;

enum {NUM_TAPS = 700};
struct {
   arm_fir_instance_f32 S;                        // Instance of FIR filter structure
   float32_t pCoeffs[NUM_TAPS];                   // Coefficients in time reversed order
   float32_t pState[NUM_TAPS + CHANNEL_SIZE - 1]; // State variable
} filter_L1, filter_R1, filter_L2, filter_R2, filter_L3, filter_R3;

float32_t coeffs1[NUM_TAPS] = {-0.0000658652,-0.0000670566,-0.0000682150,-0.0000693401,-0.0000704318,-0.0000714895,-0.0000725129,-0.0000735010,-0.0000744531,-0.0000753682,-0.0000762451,-0.0000770824,-0.0000778788,-0.0000786324,-0.0000793416,-0.0000800044,-0.000080
6186,-0.0000811819,-0.0000816920,-0.0000821461,-0.0000825416,-0.0000828756,-0.0000831451,-0.0000833468,-0.0000834774,-0.0000835335,-0.0000835116,-0.0000834080,-0.0000832189,-0.0000829405,-0.0000825687,-0.0000820995,-0.0000815289,-0.00
00808526,-0.0000800664,-0.0000791660,-0.0000781472,-0.0000770057,-0.0000757371,-0.0000743372,-0.0000728017,-0.0000711263,-0.0000693068,-0.0000673392,-0.0000652194,-0.0000629434,-0.0000605074,-0.0000579077,-0.0000551407,-0.0000522030,-
0.0000490913,-0.0000458025,-0.0000423338,-0.0000386825,-0.0000348461,-0.0000308225,-0.0000266098,-0.0000222063,-0.0000176106,-0.0000128217,-0.0000078388,-0.0000026615,0.0000027101,0.0000082759,0.0000140352,0.0000199869,0.0000261296,
0.0000324613,0.0000389799,0.0000456826,0.0000525662,0.0000596272,0.0000668616,0.0000742647,0.0000818316,0.0000895569,0.0000974346,0.0001054582,0.0001136208,0.0001219150,0.0001303328,0.0001388659,0.0001475052,0.0001562414,0.00016
50646,0.0001739642,0.0001829294,0.0001919488,0.0002010105,0.0002101021,0.0002192109,0.0002283234,0.0002374260,0.0002465044,0.0002555441,0.0002645301,0.0002734468,0.0002822785,0.0002910090,0.0002996218,0.0003080999,0.0003164262,0
.0003245831,0.0003325529,0.0003403176,0.0003478589,0.0003551583,0.0003621972,0.0003689567,0.0003754179,0.0003815618,0.0003873693,0.0003928211,0.0003978980,0.0004025810,0.0004068508,0.0004106885,0.0004140749,0.0004169914,0.000419
4193,0.0004213402,0.0004227358,0.0004235882,0.0004238800,0.0004235937,0.0004227125,0.0004212199,0.0004191001,0.0004163373,0.0004129167,0.0004088238,0.0004040447,0.0003985663,0.0003923761,0.0003854621,0.0003778133,0.0003694194,0.
0003602708,0.0003503589,0.0003396759,0.0003282148,0.0003159697,0.0003029356,0.0002891085,0.0002744854,0.0002590644,0.0002428447,0.0002258265,0.0002080113,0.0001894016,0.0001700012,0.0001498151,0.0001288494,0.0001071116,0.000084
6103,0.0000613557,0.0000373589,0.0000126325,-0.0000128095,-0.0000389520,-0.0000657782,-0.0000932703,-0.0001214090,-0.0001501737,-0.0001795422,-0.0002094912,-0.0002399961,-0.0002710306,-0.0003025673,-0.0003345775,-0.0003670309,-0.0003
998961,-0.0004331404,-0.0004667296,-0.0005006283,-0.0005348000,-0.0005692068,-0.0006038095,-0.0006385678,-0.0006734403,-0.0007083843,-0.0007433562,-0.0007783109,-0.0008132028,-0.0008479849,-0.0008826092,-0.0009170271,-0.0009511888,-0.
0009850437,-0.0010185405,-0.0010516270,-0.0010842503,-0.0011163569,-0.0011478928,-0.0011788031,-0.0012090326,-0.0012385256,-0.0012672261,-0.0012950777,-0.0013220235,-0.0013480068,-0.0013729703,-0.0013968569,-0.0014196093,-0.001441170
4,-0.0014614829,-0.0014804900,-0.0014981349,-0.0015143611,-0.0015291126,-0.0015423336,-0.0015539691,-0.0015639643,-0.0015722654,-0.0015788190,-0.0015835727,-0.0015864747,-0.0015874743,-0.0015865217,-0.0015835682,-0.0015785661,-0.00157
14691,-0.0015622318,-0.0015508104,-0.0015371623,-0.0015212466,-0.0015030237,-0.0014824555,-0.0014595056,-0.0014341395,-0.0014063242,-0.0013760285,-0.0013432232,-0.0013078811,-0.0012699766,-0.0012294866,-0.0011863896,-0.0011406667,-0.0
010923008,-0.0010412771,-0.0009875832,-0.0009312088,-0.0008721460,-0.0008103894,-0.0007459359,-0.0006787847,-0.0006089376,-0.0005363989,-0.0004611754,-0.0003832765,-0.0003027138,-0.0002195020,-0.0001336579,-0.0000452012,0.0000458459,
0.0001394586,0.0002356096,0.0003342688,0.0004354037,0.0005389790,0.0006449571,0.0007532974,0.0008639572,0.0009768910,0.0010920509,0.0012093863,0.0013288445,0.0014503699,0.0015739050,0.0016993896,0.0018267611,0.0019559550,0.00208
69041,0.0022195394,0.0023537894,0.0024895808,0.0026268380,0.0027654836,0.0029054382,0.0030466205,0.0031889475,0.0033323343,0.0034766946,0.0036219401,0.0037679815,0.0039147275,0.0040620858,0.0042099628,0.0043582634,0.0045068917,0
.0046557505,0.0048047419,0.0049537669,0.0051027258,0.0052515183,0.0054000433,0.0055481993,0.0056958845,0.0058429965,0.0059894329,0.0061350911,0.0062798685,0.0064236625,0.0065663707,0.0067078908,0.0068481211,0.0069869603,0.007124
3074,0.0072600623,0.0073941256,0.0075263987,0.0076567838,0.0077851844,0.0079115049,0.0080356510,0.0081575297,0.0082770494,0.0083941199,0.0085086529,0.0086205613,0.0087297600,0.0088361658,0.0089396974,0.0090402753,0.0091378223,0.
0092322633,0.0093235254,0.0094115380,0.0094962330,0.0095775445,0.0096554094,0.0097297669,0.0098005592,0.0098677308,0.0099312292,0.0099910047,0.0100470104,0.0100992022,0.0101475392,0.0101919832,0.0102324994,0.0102690557,0.010301
6233,0.0103301765,0.0103546927,0.0103751526,0.0103915400,0.0104038418,0.0104120485,0.0104161535,0.0104161535,0.0104120485,0.0104038418,0.0103915400,0.0103751526,0.0103546927,0.0103301765,0.0103016233,0.0102690557,0.0102324994,0.
0101919832,0.0101475392,0.0100992022,0.0100470104,0.0099910047,0.0099312292,0.0098677308,0.0098005592,0.0097297669,0.0096554094,0.0095775445,0.0094962330,0.0094115380,0.0093235254,0.0092322633,0.0091378223,0.0090402753,0.008939
6974,0.0088361658,0.0087297600,0.0086205613,0.0085086529,0.0083941199,0.0082770494,0.0081575297,0.0080356510,0.0079115049,0.0077851844,0.0076567838,0.0075263987,0.0073941256,0.0072600623,0.0071243074,0.0069869603,0.0068481211,0.
0067078908,0.0065663707,0.0064236625,0.0062798685,0.0061350911,0.0059894329,0.0058429965,0.0056958845,0.0055481993,0.0054000433,0.0052515183,0.0051027258,0.0049537669,0.0048047419,0.0046557505,0.0045068917,0.0043582634,0.004209
9628,0.0040620858,0.0039147275,0.0037679815,0.0036219401,0.0034766946,0.0033323343,0.0031889475,0.0030466205,0.0029054382,0.0027654836,0.0026268380,0.0024895808,0.0023537894,0.0022195394,0.0020869041,0.0019559550,0.0018267611,0.
0016993896,0.0015739050,0.0014503699,0.0013288445,0.0012093863,0.0010920509,0.0009768910,0.0008639572,0.0007532974,0.0006449571,0.0005389790,0.0004354037,0.0003342688,0.0002356096,0.0001394586,0.0000458459,-0.0000452012,-0.00013
36579,-0.0002195020,-0.0003027138,-0.0003832765,-0.0004611754,-0.0005363989,-0.0006089376,-0.0006787847,-0.0007459359,-0.0008103894,-0.0008721460,-0.0009312088,-0.0009875832,-0.0010412771,-0.0010923008,-0.0011406667,-0.0011863896,-0.0
012294866,-0.0012699766,-0.0013078811,-0.0013432232,-0.0013760285,-0.0014063242,-0.0014341395,-0.0014595056,-0.0014824555,-0.0015030237,-0.0015212466,-0.0015371623,-0.0015508104,-0.0015622318,-0.0015714691,-0.0015785661,-0.0015835682
,-0.0015865217,-0.0015874743,-0.0015864747,-0.0015835727,-0.0015788190,-0.0015722654,-0.0015639643,-0.0015539691,-0.0015423336,-0.0015291126,-0.0015143611,-0.0014981349,-0.0014804900,-0.0014614829,-0.0014411704,-0.0014196093,-0.001396
8569,-0.0013729703,-0.0013480068,-0.0013220235,-0.0012950777,-0.0012672261,-0.0012385256,-0.0012090326,-0.0011788031,-0.0011478928,-0.0011163569,-0.0010842503,-0.0010516270,-0.0010185405,-0.0009850437,-0.0009511888,-0.0009170271,-0.000
8826092,-0.0008479849,-0.0008132028,-0.0007783109,-0.0007433562,-0.0007083843,-0.0006734403,-0.0006385678,-0.0006038095,-0.0005692068,-0.0005348000,-0.0005006283,-0.0004667296,-0.0004331404,-0.0003998961,-0.0003670309,-0.0003345775,-
0.0003025673,-0.0002710306,-0.0002399961,-0.0002094912,-0.0001795422,-0.0001501737,-0.0001214090,-0.0000932703,-0.0000657782,-0.0000389520,-0.0000128095,0.0000126325,0.0000373589,0.0000613557,0.0000846103,0.0001071116,0.0001288494,
0.0001498151,0.0001700012,0.0001894016,0.0002080113,0.0002258265,0.0002428447,0.0002590644,0.0002744854,0.0002891085,0.0003029356,0.0003159697,0.0003282148,0.0003396759,0.0003503589,0.0003602708,0.0003694194,0.0003778133,0.00038
54621,0.0003923761,0.0003985663,0.0004040447,0.0004088238,0.0004129167,0.0004163373,0.0004191001,0.0004212199,0.0004227125,0.0004235937,0.0004238800,0.0004235882,0.0004227358,0.0004213402,0.0004194193,0.0004169914,0.0004140749,0
.0004106885,0.0004068508,0.0004025810,0.0003978980,0.0003928211,0.0003873693,0.0003815618,0.0003754179,0.0003689567,0.0003621972,0.0003551583,0.0003478589,0.0003403176,0.0003325529,0.0003245831,0.0003164262,0.0003080999,0.000299
6218,0.0002910090,0.0002822785,0.0002734468,0.0002645301,0.0002555441,0.0002465044,0.0002374260,0.0002283234,0.0002192109,0.0002101021,0.0002010105,0.0001919488,0.0001829294,0.0001739642,0.0001650646,0.0001562414,0.0001475052,0.
0001388659,0.0001303328,0.0001219150,0.0001136208,0.0001054582,0.0000974346,0.0000895569,0.0000818316,0.0000742647,0.0000668616,0.0000596272,0.0000525662,0.0000456826,0.0000389799,0.0000324613,0.0000261296,0.0000199869,0.0000140352,0.0000082759,0.0000027101,-0.0000026615,-0.0000078388,-0.0000128217,-0.0000176106,-0.0000222063,-0.0000266098,-0.0000308225,-0.0000348461,-0.0000386825,-0.0000423338,-0.0000458025,-0.0000490913,-0.0000522030,-0.0000551407,-0.000
0579077,-0.0000605074,-0.0000629434,-0.0000652194,-0.0000673392,-0.0000693068,-0.0000711263,-0.0000728017,-0.0000743372,-0.0000757371,-0.0000770057,-0.0000781472,-0.0000791660,-0.0000800664,-0.0000808526,-0.0000815289,-0.0000820995,-0
.0000825687,-0.0000829405,-0.0000832189,-0.0000834080,-0.0000835116,-0.0000835335,-0.0000834774,-0.0000833468,-0.0000831451,-0.0000828756,-0.0000825416,-0.0000821461,-0.0000816920,-0.0000811819,-0.0000806186,-0.0000800044,-0.00007934
16,-0.0000786324,-0.0000778788,-0.0000770824,-0.0000762451,-0.0000753682,-0.0000744531,-0.0000735010,-0.0000725129,-0.0000714895,-0.0000704318,-0.0000693401,-0.0000682150,-0.0000670566,-0.0000658652};  // Filter coefficients for band 1 (initially 1-tap)
float32_t coeffs2[NUM_TAPS] = {0.0000379827,0.0000575169,0.0000777888,0.0000975229,0.0001154668,0.0001304732,0.0001415757,0.0001480535,0.0001494813,0.0001457613,0.0001371333,0.0001241647,0.0001077176,0.0000888974,0.0000689841,0.0000493511,0.0000313764,0.0000
163512,0.0000053926,-0.0000006345,-0.0000011808,0.0000039430,0.0000145448,0.0000300537,0.0000495486,0.0000718098,0.0000953923,0.0001187169,0.0001401718,0.0001582200,0.0001715053,0.0001789492,0.0001798318,0.0001738522,0.000161161
7,0.0001423680,0.0001185084,0.0000909933,0.0000615222,0.0000319766,0.0000042980,-0.0000196439,-0.0000381822,-0.0000499743,-0.0000541060,-0.0000501704,-0.0000383139,-0.0000192463,0.0000057870,0.0000350719,0.0000665265,0.0000978310,0
.0001265800,0.0001504455,0.0001673409,0.0001755746,0.0001739822,0.0001620267,0.0001398591,0.0001083336,0.0000689743,0.0000238941,-0.0000243303,-0.0000728208,-0.0001185872,-0.0001587313,-0.0001906527,-0.0002122410,-0.0002220414,-0.0
002193806,-0.0002044428,-0.0001782882,-0.0001428116,-0.0001006404,-0.0000549775,-0.0000093989,0.0000323836,0.0000667771,0.0000905639,0.0001011407,0.0000967236,0.0000765034,0.0000407386,-0.0000092241,-0.0000710036,-0.0001413132,-0.0002161575,-0.0002910858,-0.0003614867,-0.0004229045,-0.0004713554,-0.0005036229,-0.0005175083,-0.0005120201,-0.0004874844,-0.0004455675,-0.0003892043,-0.0003224365,-0.0002501665,-0.0001778428,-0.0001110968,-0.0000553532,-0.0000154429
,0.0000047573,0.0000026285,-0.0000229627,-0.0000715339,-0.0001409655,-0.0002275928,-0.0003264095,-0.0004313723,-0.0005357878,-0.0006327579,-0.0007156538,-0.0007785871,-0.0008168440,-0.0008272519,-0.0008084492,-0.0007610375,-0.0006876015,-0.0005925907,-0.0004820660,-0.0003633270,-0.0002444400,-0.0001336973,-0.0000390446,0.0000324859,0.0000752963,0.0000856588,0.0000620356,0.0000052541,-0.0000814768,-0.0001927164,-0.0003211032,-0.0004578087,-0.0005931077,-0.000717
0292,-0.0008200428,-0.0008937362,-0.0009314346,-0.0009287167,-0.0008837900,-0.0007976929,-0.0006743057,-0.0005201637,-0.0003440797,-0.0001565965,0.0000306967,0.0002059410,0.0003578257,0.0004763916,0.0005537626,0.0005847541,0.000567
3099,0.0005027348,0.0003956986,0.0002540064,0.0000881435,-0.0000893790,-0.0002648382,-0.0004242208,-0.0005541906,-0.0006430357,-0.0006815296,-0.0006636432,-0.0005870539,-0.0004534110,-0.0002683330,-0.0000411281,0.0002157496,0.000487
4767,0.0007578234,0.0010102402,0.0012289967,0.0014002934,0.0015132702,0.0015608374,0.0015402672,0.0014534979,0.0013071223,0.0011120525,0.0008828751,0.0006369353,0.0003932031,0.0001709986,-0.0000113431,-0.0001377720,-0.0001957013,-
0.0001769747,-0.0000785533,0.0000971355,0.0003422179,0.0006437725,0.0009845893,0.0013442459,0.0017004347,0.0020304552,0.0023127732,0.0025285387,0.0026629590,0.0027064251,0.0026553088,0.0025123670,0.0022867130,0.0019933475,0.0016
522702,0.0012872214,0.0009241321,0.0005893826,0.0003079849,0.0001018117,-0.0000120023,-0.0000223730,0.0000748046,0.0002761868,0.0005710154,0.0009416641,0.0013646752,0.0018122262,0.0022539360,0.0026588953,0.0029977864,0.003244948
1,0.0033802421,0.0033905864,0.0032710418,0.0030253638,0.0026659696,0.0022133052,0.0016946426,0.0011423741,0.0005919077,0.0000793006,-0.0003612160,-0.0006996503,-0.0009124355,-0.0009842289,-0.0009091932,-0.0006916551,-0.0003460811,0
.0001036463,0.0006256208,0.0011818956,0.0017309354,0.0022303834,0.0026399587,0.0029242909,0.0030554934,0.0030152925,0.0027965534,0.0024040823,0.0018546290,0.0011760687,0.0004057954,-0.0004115826,-0.0012271095,-0.0019907265,-0.0026
546848,-0.0031768967,-0.0035239939,-0.0036738740,-0.0036175477,-0.0033601398,-0.0029209501,-0.0023325446,-0.0016389094,-0.0008927673,-0.0001522155,0.0005231065,0.0010760695,0.0014560598,0.0016226604,0.0015487484,0.0012227796,0.0006
500792,-0.0001469788,-0.0011299517,-0.0022464357,-0.0034331942,-0.0046201267,-0.0057348346,-0.0067074949,-0.0074757195,-0.0079890723,-0.0082129252,-0.0081313720,-0.0077489694,-0.0070911506,-0.0062032357,-0.0051480589,-0.0040023246,-0.
0028518911,-0.0017862630,-0.0008926328,-0.0002498544,0.0000772492,0.0000428522,-0.0003759936,-0.0011768622,-0.0023310608,-0.0037844620,-0.0054600715,-0.0072622310,-0.0090822424,-0.0108051002,-0.0123169338,-0.0135127012,-0.0143036403
,-0.0146239820,-0.0144364568,-0.0137361852,-0.0125526323,-0.0109494134,-0.0090218699,-0.0068924693,-0.0047042239,-0.0026124543,-0.0007753387,0.0006562160,0.0015487854,0.0017960946,0.0013275247,0.0001148906,-0.0018229972,-0.004418356
9,-0.0075552761,-0.0110734387,-0.0147746408,-0.0184318313,-0.0218002545,-0.0246301374,-0.0266802588,-0.0277316627,-0.0276007513,-0.0261510062,-0.0233026412,-0.0190395928,-0.0134133831,-0.0065435604,0.0013854006,0.0101306567,0.0194007
452,0.0288680691,0.0381835134,0.0469924577,0.0549513664,0.0617440963,0.0670970684,0.0707925025,0.0726790153,0.0726790153,0.0707925025,0.0670970684,0.0617440963,0.0549513664,0.0469924577,0.0381835134,0.0288680691,0.0194007452,0.0
101306567,0.0013854006,-0.0065435604,-0.0134133831,-0.0190395928,-0.0233026412,-0.0261510062,-0.0276007513,-0.0277316627,-0.0266802588,-0.0246301374,-0.0218002545,-0.0184318313,-0.0147746408,-0.0110734387,-0.0075552761,-0.0044183569,
-0.0018229972,0.0001148906,0.0013275247,0.0017960946,0.0015487854,0.0006562160,-0.0007753387,-0.0026124543,-0.0047042239,-0.0068924693,-0.0090218699,-0.0109494134,-0.0125526323,-0.0137361852,-0.0144364568,-0.0146239820,-0.0143036403
,-0.0135127012,-0.0123169338,-0.0108051002,-0.0090822424,-0.0072622310,-0.0054600715,-0.0037844620,-0.0023310608,-0.0011768622,-0.0003759936,0.0000428522,0.0000772492,-0.0002498544,-0.0008926328,-0.0017862630,-0.0028518911,-0.0040023
246,-0.0051480589,-0.0062032357,-0.0070911506,-0.0077489694,-0.0081313720,-0.0082129252,-0.0079890723,-0.0074757195,-0.0067074949,-0.0057348346,-0.0046201267,-0.0034331942,-0.0022464357,-0.0011299517,-0.0001469788,0.0006500792,0.0012
227796,0.0015487484,0.0016226604,0.0014560598,0.0010760695,0.0005231065,-0.0001522155,-0.0008927673,-0.0016389094,-0.0023325446,-0.0029209501,-0.0033601398,-0.0036175477,-0.0036738740,-0.0035239939,-0.0031768967,-0.0026546848,-0.001
9907265,-0.0012271095,-0.0004115826,0.0004057954,0.0011760687,0.0018546290,0.0024040823,0.0027965534,0.0030152925,0.0030554934,0.0029242909,0.0026399587,0.0022303834,0.0017309354,0.0011818956,0.0006256208,0.0001036463,-0.00034608
11,-0.0006916551,-0.0009091932,-0.0009842289,-0.0009124355,-0.0006996503,-0.0003612160,0.0000793006,0.0005919077,0.0011423741,0.0016946426,0.0022133052,0.0026659696,0.0030253638,0.0032710418,0.0033905864,0.0033802421,0.0032449481,
0.0029977864,0.0026588953,0.0022539360,0.0018122262,0.0013646752,0.0009416641,0.0005710154,0.0002761868,0.0000748046,-0.0000223730,-0.0000120023,0.0001018117,0.0003079849,0.0005893826,0.0009241321,0.0012872214,0.0016522702,0.0019
933475,0.0022867130,0.0025123670,0.0026553088,0.0027064251,0.0026629590,0.0025285387,0.0023127732,0.0020304552,0.0017004347,0.0013442459,0.0009845893,0.0006437725,0.0003422179,0.0000971355,-0.0000785533,-0.0001769747,-0.00019570
13,-0.0001377720,-0.0000113431,0.0001709986,0.0003932031,0.0006369353,0.0008828751,0.0011120525,0.0013071223,0.0014534979,0.0015402672,0.0015608374,0.0015132702,0.0014002934,0.0012289967,0.0010102402,0.0007578234,0.0004874767,0.0
002157496,-0.0000411281,-0.0002683330,-0.0004534110,-0.0005870539,-0.0006636432,-0.0006815296,-0.0006430357,-0.0005541906,-0.0004242208,-0.0002648382,-0.0000893790,0.0000881435,0.0002540064,0.0003956986,0.0005027348,0.0005673099,0.0
005847541,0.0005537626,0.0004763916,0.0003578257,0.0002059410,0.0000306967,-0.0001565965,-0.0003440797,-0.0005201637,-0.0006743057,-0.0007976929,-0.0008837900,-0.0009287167,-0.0009314346,-0.0008937362,-0.0008200428,-0.0007170292,-0.
0005931077,-0.0004578087,-0.0003211032,-0.0001927164,-0.0000814768,0.0000052541,0.0000620356,0.0000856588,0.0000752963,0.0000324859,-0.0000390446,-0.0001336973,-0.0002444400,-0.0003633270,-0.0004820660,-0.0005925907,-0.0006876015,-0
.0007610375,-0.0008084492,-0.0008272519,-0.0008168440,-0.0007785871,-0.0007156538,-0.0006327579,-0.0005357878,-0.0004313723,-0.0003264095,-0.0002275928,-0.0001409655,-0.0000715339,-0.0000229627,0.0000026285,0.0000047573,-0.000015442
9,-0.0000553532,-0.0001110968,-0.0001778428,-0.0002501665,-0.0003224365,-0.0003892043,-0.0004455675,-0.0004874844,-0.0005120201,-0.0005175083,-0.0005036229,-0.0004713554,-0.0004229045,-0.0003614867,-0.0002910858,-0.0002161575,-0.00014
13132,-0.0000710036,-0.0000092241,0.0000407386,0.0000765034,0.0000967236,0.0001011407,0.0000905639,0.0000667771,0.0000323836,-0.0000093989,-0.0000549775,-0.0001006404,-0.0001428116,-0.0001782882,-0.0002044428,-0.0002193806,-0.00022
20414,-0.0002122410,-0.0001906527,-0.0001587313,-0.0001185872,-0.0000728208,-0.0000243303,0.0000238941,0.0000689743,0.0001083336,0.0001398591,0.0001620267,0.0001739822,0.0001755746,0.0001673409,0.0001504455,0.0001265800,0.00009783
10,0.0000665265,0.0000350719,0.0000057870,-0.0000192463,-0.0000383139,-0.0000501704,-0.0000541060,-0.0000499743,-0.0000381822,-0.0000196439,0.0000042980,0.0000319766,0.0000615222,0.0000909933,0.0001185084,0.0001423680,0.0001611617,
0.0001738522,0.0001798318,0.0001789492,0.0001715053,0.0001582200,0.0001401718,0.0001187169,0.0000953923,0.0000718098,0.0000495486,0.0000300537,0.0000145448,0.0000039430,-0.0000011808,-0.0000006345,0.0000053926,0.0000163512,0.0000
313764,0.0000493511,0.0000689841,0.0000888974,0.0001077176,0.0001241647,0.0001371333,0.0001457613,0.0001494813,0.0001480535,0.0001415757,0.0001304732,0.0001154668,0.0000975229,0.0000777888,0.0000575169,0.0000379827};  // Filter coefficients for band 2 (initially 1-tap)
float32_t coeffs3[NUM_TAPS] = {-0.0000673144,-0.0000724614,-0.0000727206,-0.0000680392,-0.0000586908,-0.0000452598,-0.0000286068,-0.0000098150,0.0000098776,0.0000291578,0.0000467212,0.0000613588,0.0000720374,0.00007
79702,0.0000786734,0.0000740035,0.0000641737,0.0000497464,0.0000316042,0.0000108983,-0.0000110223,-0.0000326950,-0.0000526389,-0.0000694528,-0.0000819112,-0.0000890509,-0.0000902427,-0.0
000852432,-0.0000742224,-0.0000577640,-0.0000368388,-0.0000127505,0.0000129418,0.0000385217,0.0000622266,0.0000823664,0.0000974405,0.0001062467,0.0001079732,0.0001022675,0.0000892757,
0.0000696504,0.0000445234,0.0000154446,-0.0000157095,-0.0000468533,-0.0000758283,-0.0001005492,-0.0001191505,-0.0001301235,-0.0001324332,-0.0001256078,-0.0001097918,-0.0000857588,-0.0000
548811,-0.0000190570,0.0000194019,0.0000579155,0.0000938046,0.0001244735,0.0001475941,0.0001612772,0.0001642214,0.0001558251,0.0001362548,0.0001064624,0.0000681477,0.0000236684,-0.0000241005,-0.0000719481,-0.0001165390,-0.0001546420,-0.0001833597,-0.0002003433,-0.0002039770,-0.0001935185,-0.0001691823,-0.0001321608,-0.0000845761,-0.0000293658,0.0000298925,0.000089208
9,0.0001444446,0.0001915967,0.0002270832,0.0002480088,0.0002523923,0.0002393378,0.0002091366,0.0001632890,0.0001044417,0.0000362439,-0.0000368735,-0.0001099802,-0.0001779741,-0.0002359
326,-0.0002794634,-0.0003050303,-0.0003102302,-0.0002940005,-0.0002567395,-0.0002003283,-0.0001280501,-0.0000444077,0.0000451497,0.0001345764,0.0002176326,0.0002883147,0.0003412826,0.0003722560,0.0003783482,0.0003583141,0.0003126918,0.0002438226,0.0001557468,0.0000539766,-0.0000548416,-0.0001633552,-0.0002639958,-0.0003495019,-0.0004134353,-0.0004506575,-0.0004577296
,-0.0004332065,-0.0003778003,-0.0002943987,-0.0001879311,-0.0000650885,0.0000660890,0.0001967317,0.0003177331,0.0004203787,0.0004969657,0.0005413710,0.0005495269,0.0005197667,0.0004530
139,0.0003527954,0.0002250742,0.0000779065,-0.0000790576,-0.0002351989,-0.0003796406,-0.0005019988,-0.0005931200,-0.0006457551,-0.0006551202,-0.0006193018,-0.0005394731,-0.0004199023,-0.0002677447,-0.0000926278,0.0000939477,0.0002793545,0.0004506858,0.0005956447,0.0007034180,0.0007654695,0.0007761991,0.0007334144,0.0006385792,0.0004968142,0.0003166434,0.0001094958,-
0.0001110075,-0.0003299398,-0.0005320700,-0.0007029124,-0.0008297541,-0.0009025870,-0.0009148769,-0.0008641128,-0.0007520911,-0.0005849081,-0.0003726535,-0.0001288180,0.0001305507,0.00038
78935,0.0006253179,0.0008258305,0.0009745411,0.0010597519,0.0010738549,0.0010139689,0.0008822657,0.0006859537,0.0004369121,0.0001509909,-0.0001529826,-0.0004544311,-0.0007324071,-0.000
9670355,-0.0011409199,-0.0012404133,-0.0012566630,-0.0011863496,-0.0010320628,-0.0008022765,-0.0005109163,-0.0001765375,0.0001788392,0.0005311620,0.0008559610,0.0011300315,0.0013330735,
0.0014491737,0.0014680207,0.0013857654,0.0012054554,0.0009370042,0.0005966837,0.0002061640,-0.0002088453,-0.0006202686,-0.0009995448,-0.0013195903,-0.0015567104,-0.0016923270,-0.001714
3959,-0.0016184110,-0.0014079124,-0.0010944518,-0.0006970039,-0.0002408493,0.0002440079,0.0007247889,0.0011681327,0.0015423856,0.0018198331,0.0019787178,0.0020048999,0.0018930349,0.001
6471760,0.0012807432,0.0008158462,0.0002819894,-0.0002857674,-0.0008490798,-0.0013688775,-0.0018080404,-0.0021340124,-0.0023211708,-0.0023527815,-0.0022223946,-0.0019345697,-0.001504861
8,-0.0009590508,-0.0003316451,0.0003362559,0.0009996120,0.0016124367,0.0021309390,0.0025166022,0.0027389849,0.0027780465,0.0026258216,0.0022873129,0.0017805178,0.0011355636,0.00039298
47,-0.0003987645,-0.0011864113,-0.0019153883,-0.0025335472,-0.0029948169,-0.0032625520,-0.0033123345,-0.0031340221,-0.0027328786,-0.0021296846,-0.0013597889,-0.0004711337,0.0004786427,0.0
014258552,0.0023049495,0.0030529383,0.0036138031,0.0039425602,0.0040087050,0.0037987800,0.0033178647,0.0025898518,0.0016564504,0.0005749438,-0.0005851879,-0.0017465913,-0.0028290453,-
0.0037548372,-0.0044541571,-0.0048701487,-0.0049632629,-0.0047145990,-0.0041279714,-0.0032305180,-0.0020717570,-0.0007210992,0.0007360759,0.0022035709,0.0035804508,0.0047676834,0.005674
9208,0.0062269770,0.0063695599,0.0060738517,0.0053395872,0.0041963675,0.0027030504,0.0009451771,-0.0009694784,-0.0029170291,-0.0047649368,-0.0063803940,-0.0076391247,-0.0084340598,-0.00
86833272,-0.0083370177,-0.0073822441,-0.0058460965,-0.0037962130,-0.0013388199,0.0013857550,0.0042099385,0.0069478297,0.0094057400,0.0113937974,0.0127379825,0.0132919106,0.0129476754,0
.0116450985,0.0093788153,0.0062027355,0.0022315746,-0.0023606746,-0.0073452576,-0.0124458726,-0.0173480624,-0.0217100144,-0.0251737034,-0.0273749369,-0.0279502769,-0.0265377817,-0.022766
4389,-0.0162246178,-0.0063869484,0.0075498956,0.0270591302,0.0553516205,0.1010011526,0.1960451284,0.6311704696,-0.6311704696,-0.1960451284,-0.1010011526,-0.0553516205,-0.0270591302,-0.00
75498956,0.0063869484,0.0162246178,0.0227664389,0.0265377817,0.0279502769,0.0273749369,0.0251737034,0.0217100144,0.0173480624,0.0124458726,0.0073452576,0.0023606746,-0.0022315746,-0.0062027355,-0.0093788153,-0.0116450985,-0.0129476754,-0.0132919106,-0.0127379825,-0.0113937974,-0.0094057400,-0.0069478297,-0.0042099385,-0.0013857550,0.0013388199,0.0037962130,0.0058460
965,0.0073822441,0.0083370177,0.0086833272,0.0084340598,0.0076391247,0.0063803940,0.0047649368,0.0029170291,0.0009694784,-0.0009451771,-0.0027030504,-0.0041963675,-0.0053395872,-0.0060
738517,-0.0063695599,-0.0062269770,-0.0056749208,-0.0047676834,-0.0035804508,-0.0022035709,-0.0007360759,0.0007210992,0.0020717570,0.0032305180,0.0041279714,0.0047145990,0.0049632629,0.
0048701487,0.0044541571,0.0037548372,0.0028290453,0.0017465913,0.0005851879,-0.0005749438,-0.0016564504,-0.0025898518,-0.0033178647,-0.0037987800,-0.0040087050,-0.0039425602,-0.0036138031,-0.0030529383,-0.0023049495,-0.0014258552,-0.0004786427,0.0004711337,0.0013597889,0.0021296846,0.0027328786,0.0031340221,0.0033123345,0.0032625520,0.0029948169,0.0025335472,0.00191
53883,0.0011864113,0.0003987645,-0.0003929847,-0.0011355636,-0.0017805178,-0.0022873129,-0.0026258216,-0.0027780465,-0.0027389849,-0.0025166022,-0.0021309390,-0.0016124367,-0.0009996120,-
0.0003362559,0.0003316451,0.0009590508,0.0015048618,0.0019345697,0.0022223946,0.0023527815,0.0023211708,0.0021340124,0.0018080404,0.0013688775,0.0008490798,0.0002857674,-0.0002819894,
-0.0008158462,-0.0012807432,-0.0016471760,-0.0018930349,-0.0020048999,-0.0019787178,-0.0018198331,-0.0015423856,-0.0011681327,-0.0007247889,-0.0002440079,0.0002408493,0.0006970039,0.0010
944518,0.0014079124,0.0016184110,0.0017143959,0.0016923270,0.0015567104,0.0013195903,0.0009995448,0.0006202686,0.0002088453,-0.0002061640,-0.0005966837,-0.0009370042,-0.0012054554,-0.0
013857654,-0.0014680207,-0.0014491737,-0.0013330735,-0.0011300315,-0.0008559610,-0.0005311620,-0.0001788392,0.0001765375,0.0005109163,0.0008022765,0.0010320628,0.0011863496,0.001256663
0,0.0012404133,0.0011409199,0.0009670355,0.0007324071,0.0004544311,0.0001529826,-0.0001509909,-0.0004369121,-0.0006859537,-0.0008822657,-0.0010139689,-0.0010738549,-0.0010597519,-0.00097
45411,-0.0008258305,-0.0006253179,-0.0003878935,-0.0001305507,0.0001288180,0.0003726535,0.0005849081,0.0007520911,0.0008641128,0.0009148769,0.0009025870,0.0008297541,0.0007029124,0.000
5320700,0.0003299398,0.0001110075,-0.0001094958,-0.0003166434,-0.0004968142,-0.0006385792,-0.0007334144,-0.0007761991,-0.0007654695,-0.0007034180,-0.0005956447,-0.0004506858,-0.000279354
5,-0.0000939477,0.0000926278,0.0002677447,0.0004199023,0.0005394731,0.0006193018,0.0006551202,0.0006457551,0.0005931200,0.0005019988,0.0003796406,0.0002351989,0.0000790576,-0.00007790
65,-0.0002250742,-0.0003527954,-0.0004530139,-0.0005197667,-0.0005495269,-0.0005413710,-0.0004969657,-0.0004203787,-0.0003177331,-0.0001967317,-0.0000660890,0.0000650885,0.0001879311,0.00
02943987,0.0003778003,0.0004332065,0.0004577296,0.0004506575,0.0004134353,0.0003495019,0.0002639958,0.0001633552,0.0000548416,-0.0000539766,-0.0001557468,-0.0002438226,-0.0003126918,-0
.0003583141,-0.0003783482,-0.0003722560,-0.0003412826,-0.0002883147,-0.0002176326,-0.0001345764,-0.0000451497,0.0000444077,0.0001280501,0.0002003283,0.0002567395,0.0002940005,0.0003102
302,0.0003050303,0.0002794634,0.0002359326,0.0001779741,0.0001099802,0.0000368735,-0.0000362439,-0.0001044417,-0.0001632890,-0.0002091366,-0.0002393378,-0.0002523923,-0.0002480088,-0.00
02270832,-0.0001915967,-0.0001444446,-0.0000892089,-0.0000298925,0.0000293658,0.0000845761,0.0001321608,0.0001691823,0.0001935185,0.0002039770,0.0002003433,0.0001833597,0.0001546420,0.
0001165390,0.0000719481,0.0000241005,-0.0000236684,-0.0000681477,-0.0001064624,-0.0001362548,-0.0001558251,-0.0001642214,-0.0001612772,-0.0001475941,-0.0001244735,-0.0000938046,-0.000057
9155,-0.0000194019,0.0000190570,0.0000548811,0.0000857588,0.0001097918,0.0001256078,0.0001324332,0.0001301235,0.0001191505,0.0001005492,0.0000758283,0.0000468533,0.0000157095,-0.00001
54446,-0.0000445234,-0.0000696504,-0.0000892757,-0.0001022675,-0.0001079732,-0.0001062467,-0.0000974405,-0.0000823664,-0.0000622266,-0.0000385217,-0.0000129418,0.0000127505,0.0000368388,
0.0000577640,0.0000742224,0.0000852432,0.0000902427,0.0000890509,0.0000819112,0.0000694528,0.0000526389,0.0000326950,0.0000110223,-0.0000108983,-0.0000316042,-0.0000497464,-0.00006417
37,-0.0000740035,-0.0000786734,-0.0000779702,-0.0000720374,-0.0000613588,-0.0000467212,-0.0000291578,-0.0000098776,0.0000098150,0.0000286068,0.0000452598,0.0000586908,0.0000680392,0.0000727206,0.0000724614,0.0000673144};  // Filter coefficients for band 3 (initially 1-tap)


float32_t filt_in_L[CHANNEL_SIZE];
float32_t filt_in_R[CHANNEL_SIZE];

float32_t filt_out_L1[CHANNEL_SIZE];
float32_t filt_out_L2[CHANNEL_SIZE];
float32_t filt_out_L3[CHANNEL_SIZE];
float32_t filt_out_R1[CHANNEL_SIZE];
float32_t filt_out_R2[CHANNEL_SIZE];
float32_t filt_out_R3[CHANNEL_SIZE];

/*
This function will be called once before beginning the main program loop.
This is the best place to build a lookup table.
*/
void lab_init(int16_t* output_buffer)
{
   arm_fir_init_f32(&filter_L1.S, NUM_TAPS, coeffs1, filter_L1.pState, CHANNEL_SIZE);
   arm_fir_init_f32(&filter_R1.S, NUM_TAPS, coeffs1, filter_R1.pState, CHANNEL_SIZE);

   arm_fir_init_f32(&filter_L2.S, NUM_TAPS, coeffs2, filter_L2.pState, CHANNEL_SIZE);
   arm_fir_init_f32(&filter_R2.S, NUM_TAPS, coeffs2, filter_R2.pState, CHANNEL_SIZE);

   arm_fir_init_f32(&filter_L3.S, NUM_TAPS, coeffs3, filter_L3.pState, CHANNEL_SIZE);
   arm_fir_init_f32(&filter_R3.S, NUM_TAPS, coeffs3, filter_R3.pState, CHANNEL_SIZE);

   return;
}


/*
This function will be called when an event needs to trigger some update.
*/
void lab_event_update(int16_t event)
{
	return;
}


/*
This function will be called each time a complete frame of data is recorded.
Default behavior:
	1. Deinterleave the left and right channels
	2. Combine the two channels (by addition) into one signal
	3. Save the result to the fft_in buffer which will be used for the display
	4. The original audio buffer is left unchanged (passthrough)
*/
void process_input_buffer(int16_t* input_buffer)
{
	// Compute the spectrum of the input buffer
	if ( spectrum_input_or_output == 0 )
		calculate_spectrum(input_buffer);

	return;
}


/*
This function provides access to the current input buffer and output buffer and is
useful for block-based processing and filtering of the input directly to the output.
The only caveat is that both the input buffer and output buffer are interleaved with
left and right samples (i.e., input_buffer[0] is first left channel sample,
input_buffer[1] is first right channel sample, input_buffer[2] is second left channel
sample, input_buffer[3] is second right channel sample, etc.).

What is returned in output_buffer will be sent to the left channel DAC.
Default behavior:
	1. Copy input to output without modification (passthrough)
	2. Estimate the number of cycles that have elapsed during the function call
*/
void process_input_to_output_buffer(int16_t* input_buffer, int16_t* output_buffer)
{
   // Grab left channel input, convert to float32_t, and store in input_f32
   for (uint32_t i_sample = 0; i_sample < BUFFER_SIZE; i_sample+=2)
   {
      filt_in_L[i_sample/2] = ((float32_t)input_buffer[i_sample]);
      filt_in_R[i_sample/2] = ((float32_t)input_buffer[i_sample+1]);
   }

   // Filter input with each of the three filters for left channel
   arm_fir_f32(&filter_L1.S, filt_in_L, filt_out_L1, CHANNEL_SIZE);
   arm_fir_f32(&filter_L2.S, filt_in_L, filt_out_L2, CHANNEL_SIZE);
   arm_fir_f32(&filter_L3.S, filt_in_L, filt_out_L3, CHANNEL_SIZE);

   // Filter input with each of the three filters for right channel
   arm_fir_f32(&filter_R1.S, filt_in_R, filt_out_R1, CHANNEL_SIZE);
   arm_fir_f32(&filter_R2.S, filt_in_R, filt_out_R2, CHANNEL_SIZE);
   arm_fir_f32(&filter_R3.S, filt_in_R, filt_out_R3, CHANNEL_SIZE);

   // Store filtered output (float32_t) to both left and right output channels (int16_t)
   for (uint32_t i_sample = 0; i_sample < BUFFER_SIZE; i_sample+=2)
   {
      // Store left channel sample in output buffer
      output_buffer[i_sample] = (int16_t)((filt_out_L1[i_sample/2] * gain1 + filt_out_L2[i_sample/2] * gain2 + filt_out_L3[i_sample/2] * gain3) * volume);

      // Store right channel sample in output buffer
      output_buffer[i_sample+1] = (int16_t)((filt_out_R1[i_sample/2] * gain1 + filt_out_R2[i_sample/2] * gain2 + filt_out_R3[i_sample/2] * gain3) * volume);

   }

   return;
}


/*
This function provides access to each individual sample that is incoming on the left channel.
The returned value will be sent to the left channel DAC.
Default behavior:
	1. Copy input to output without modification (passthrough)
	2. Estimate the number of cycles that have elapsed during the function call
*/
int16_t process_left_sample(int16_t input_sample)
{
	tic();
	int16_t output_sample;
	output_sample = input_sample;
	elapsed_cycles = toc();
	return output_sample;
}

/*
This function provides access to each individual sample that is incoming on the left channel.
The returned value will be sent to the right channel DAC.
Default behavior:
	1. Copy input to output without modification (passthrough)
	2. Estimate the number of cycles that have elapsed during the function call
*/
int16_t process_right_sample(int16_t input_sample)
{
	tic();
	int16_t output_sample;
	output_sample = input_sample;
	elapsed_cycles = toc();
	return output_sample;
}

/*
This function provides another opportunity to access the frame of data
The default behavior is to leave the buffer unchanged (passthrough)
The buffer you see here will have any changes that occurred to the signal due to:
	1. the process_input_buffer function
	2. the process_left_sample and process_right_sample functions or process_input_to_output function
*/
void process_output_buffer(int16_t* output_buffer)
{
	// Compute the spectrum of the output buffer
	if ( spectrum_input_or_output == 1 )
		calculate_spectrum(output_buffer);

	return;
}


